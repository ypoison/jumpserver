{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block custom_head_css_js %}
    <link href="{% static 'css/plugins/ztree/awesomeStyle/awesome.css' %}" rel="stylesheet">
{#    <link href="https://cdn.datatables.net/1.10.19/css/jquery.dataTables.min.css" rel="stylesheet">#}
    <script type="text/javascript" src="{% static 'js/plugins/ztree/jquery.ztree.all.min.js' %}"></script>
    <script src="{% static 'js/jquery.form.min.js' %}"></script>

{% endblock %}

{% block content %}
<div class="wrapper wrapper-content">
   <div class="row">
       <div class="col-lg-3" id="split-left" style="padding-left: 3px">
           <div class="ibox float-e-margins">
               <div class="ibox-content mailbox-content" style="padding-top: 0;padding-left: 1px">
                   <div class="file-manager ">
                       <div id="recordTree" class="ztree">
                       </div>
                       <div class="clearfix"></div>
                   </div>
               </div>
           </div>
       </div>
       <div class="col-lg-9 animated fadeInRight" id="split-right">
           <div class="tree-toggle">
               <div class="btn btn-sm btn-primary tree-toggle-btn" onclick="toggle()">
                   <i class="fa fa-angle-left fa-x" id="toggle-icon"></i>
               </div>
           </div>
           <div class="mail-box-header">
               <table class="table table-striped table-bordered table-hover " id="record_list_table" style="width: 100%">
                   <thead>
                       <tr>
                           <th class="text-center"><input type="checkbox" class="ipt_check_all"></th>
                           <th class="text-center">平台</th>
                           <th class="text-center">{% trans 'name' %}</th>
                           <th class="text-center">大小</th>
                           <th class="text-center">{% trans 'Action' %}</th>
                       </tr>
                   </thead>
                   <tbody>
                   </tbody>
               </table>
           </div>
       </div>
   </div>
</div>

{% endblock %}

{% block custom_foot_js %}
<script>
var zTree, rMenu, record_table, show = 0;
var update_node_action = "";
var current_node_id = null;
var current_node = null;
function initTable() {
    var options = {
        ele: $('#record_list_table'),
        columnDefs: [
            {targets: 2, createdCell: function (td, cellData, rowData) {
                var dataset = [];
                dataset.push('path: ' + rowData['path'])
                dataset.push('md5: ' + rowData['md5'])
                var data_content = dataset.join("<br><br>");
                var html = "<a data-toggle='popover' data-content='" + data_content + "'>" + cellData + "</a>";
                $(td).html(html);
             }},
            {targets: 4, createdCell: function (td, cellData, rowData) {
                var update_btn = '<a href="{{ DEFAULT_PK }}" class="btn btn-xs btn-info">下载</a>'.replace("{{ DEFAULT_PK }}", cellData);
                var del_btn = '<a class="btn btn-xs btn-default m-l-xs btn_asset_delete" data-uid="{{ DEFAULT_PK }}">共享</a>'.replace('{{ DEFAULT_PK }}', cellData);
                $(td).html(update_btn + del_btn)
            }}
        ],
        ajax_url: '{% url "api-backup:record-list" %}',
        columns: [
            {data: "id"}, {data: "platform" }, {data: "name" },
            {data: "size"}, {data: "download_url", orderable: false }
        ],
        op_html: $('#actions').html()
    };
    record_table = jumpserver.initServerSideDataTable(options);
    return record_table
}

function onSelected(event, treeNode) {
    current_node = treeNode;
    current_node_id = treeNode.meta.node.id;
    zTree.expandNode(current_node, true);
    var url = record_table.ajax.url();
    url = setUrlParam(url, "tree_id", current_node_id);
    console.log(url)
    url = setUrlParam(url, "show_current_asset", getCookie('show_current_asset'));
    console.log(url)
    setCookie('backup_records_selected', treeNode.node_id);
    record_table.ajax.url(url);
    record_table.ajax.reload();
}

function initTree() {
    if (zTree) {
        return
    }
    var url = '{% url 'api-backup:records-platform-tree' %}';
    //var showCurrentBackupRecords = getCookie('show_current_backup_records');
    //if (!show_current_backup_records) {
    //    url += '1'
    //}
    var setting = {
        view: {
            dblClickExpand: false,
            showLine: true
        },
        data: {
            key:{
                title:"title"
            },
            simpleData: {
                enable: true
            }
        },
        async: {
			enable: true,
			url: url,
			autoParam: ["id=key", "name=n", "level=lv"],
            type: 'get'
		},
        callback: {
            onSelected: onSelected,
        }
    };

    var zNodes = [];
    zTree = $.fn.zTree.init($("#recordTree"), setting, zNodes);
}

$(document).ready(function(){
    initTable();
    initTree();
})

.on('click', '.btn-refresh-hardware', function () {
    var url = "{% url 'api-assets:node-refresh-hardware-info' pk=DEFAULT_PK %}";
    var the_url = url.replace("{{ DEFAULT_PK }}", current_node_id);
    function success(data) {
        rMenu.css({"visibility" : "hidden"});
        var task_id = data.task;
        var url = '{% url "ops:celery-task-log" pk=DEFAULT_PK %}'.replace("{{ DEFAULT_PK }}", task_id);
        window.open(url, '', 'width=800,height=600')
    }
    APIUpdateAttr({
        url: the_url,
        method: "GET",
        success: success,
        flash_message: false
    });

})
.on('click', '.btn-test-connective', function () {
    var url = "{% url 'api-assets:node-test-connective' pk=DEFAULT_PK %}";
    if (!current_node_id) {
        return null;
    }
    var the_url = url.replace("{{ DEFAULT_PK }}", current_node_id);
    function success(data) {
        rMenu.css({"visibility" : "hidden"});
        var task_id = data.task;
        var url = '{% url "ops:celery-task-log" pk=DEFAULT_PK %}'.replace("{{ DEFAULT_PK }}", task_id);
        window.open(url, '', 'width=800,height=600')
    }
    APIUpdateAttr({
        url: the_url,
        method: "GET",
        success: success,
        flash_message: false
    });
})
</script>

{% endblock %}