{% extends '_base_create_update.html' %}
{% load static %}
{% load bootstrap3 %}
{% load i18n %}
{% block form %}
<form id="groupForm" method="post" class="form-horizontal">
    {% csrf_token %}
    <h3>账号</h3>
    {% bootstrap_field form.account layout="horizontal" %}
    {% bootstrap_field form.project layout="horizontal" %}
    {% bootstrap_field form.nodes layout="horizontal" %}
    {% bootstrap_field form.charge_type layout="horizontal" %}
    <div class="hr-line-dashed"></div>
    <h3>地域</h3>
    {% bootstrap_field form.region layout="horizontal" %}
    {% bootstrap_field form.zone layout="horizontal" %}
    <div class="hr-line-dashed"></div>
    <h3>基础配置</h3>
    {% bootstrap_field form.host_type layout="horizontal" %}
    {% bootstrap_field form.net_capability layout="horizontal" %}
    {% bootstrap_field form.cpu layout="horizontal" %}
    {% bootstrap_field form.memory layout="horizontal" %}
    {% bootstrap_field form.disks0_type layout="horizontal" %}
    {% bootstrap_field form.disks0_size layout="horizontal" %}
    {% bootstrap_field form.disks1_type layout="horizontal" %}
    {% bootstrap_field form.disks1_size layout="horizontal" %}
    {% bootstrap_field form.os_type layout="horizontal" %}
    {% bootstrap_field form.image_type layout="horizontal" %}
    {% bootstrap_field form.image layout="horizontal" %}
    <div class="hr-line-dashed"></div>
    <h3>网络配置</h3>
    {% bootstrap_field form.vpc layout="horizontal" %}
    {% bootstrap_field form.subnet layout="horizontal" %}
    {% bootstrap_field form.eip layout="horizontal" %}
    <div class="vpc" style="display:none">
        {% bootstrap_field form.eip_pay_mode layout="horizontal" %}
        {% bootstrap_field form.eip_bandwidth layout="horizontal" %}
    </div>
    <div class="hr-line-dashed"></div>
    <h3>管理设置</h3>
    {% bootstrap_field form.name layout="horizontal" %}
    {% bootstrap_field form.passwd layout="horizontal" %}
    <div class="hr-line-dashed"></div>
    <div class="form-group">
        <div class="col-sm-4 col-sm-offset-2">
            <button class="btn btn-default" type="reset"> {% trans 'Reset' %}</button>
            <button id="submit_button" class="btn btn-primary" type="submit">{% trans 'Submit' %}</button>
        </div>
    </div>
</form>
{% endblock %}

{% block custom_foot_js %}
<script type="text/javascript">
function hideHasError() {
    var domain_form_group = $("#id_domain").closest('.form-group');
    if (domain_form_group.hasClass('has-error')) {
        domain_form_group.removeClass('has-error');
        domain_form_group.find('.help-block').hide();
    }
}

function getInfo(props) {
    console.log(props)
    var url = '{% url "api-cmis:chost-get-info" %}';
    $(".splash").show();
    $.ajax({
        url: url,
        data: JSON.stringify(props.data),
        type: "POST",
        contentType:"application/json; charset=utf-8",
        dataType:"json"
    }).done(function(ret) {
        if (ret.code != 0) {
            var data = ret['msg'];
            $("#" + props.to + " option").remove();
            for (var i = 0; i < data.length; i++) {
                if (data[i].IsDefault) {
                    $("#" + props.to).append("<option value =" + data[i].id + " selected>" + data[i].name + "</option>")
                } else {
                    $("#" + props.to).append("<option value =" + data[i].id + ">" + data[i].name + "</option>")
                }
            }
            if (typeof props.success === 'function') {
                return props.success(props.data);
            }
            $(".splash").hide();
        } else {
            $("#" + props.to + " option").remove();
            $("#" + props.to).append("<option value='' >没有相关信息</option>")
            $(".splash").hide();
        }
    });
}
function getZone(id, region) {
    getInfo({
        to: 'id_zone',
        data: {'action': 'getzone','account_id': id, 'region':region}
    })
}
function getSubnet(id, region, projectID) {
    var vpcID = $("#id_vpc").val();
    getInfo({
        to: 'id_subnet',
        data: {'action': 'getsubnet','account_id': id, 'region':region, 'project_id':projectID, vpc_id:vpcID}
    })
}
function getVPC(id, region, projectID) {
    var subnet = function () {
        getSubnet(id, region, projectID)
    }
    getInfo({
        to: 'id_vpc',
        data: {'action': 'getVPC','account_id': id, 'region':region, 'project_id':projectID},
        success: subnet
    })
}
function getRegion(id) {
    var getOther = function () {
        //get zone
        var region = $("#id_region").val();
        getZone(id, region)
        var projectid = $("#id_project").val();
        getVPC(id, region, projectid)
    }
    getInfo({
        //get region
        to: 'id_region',
        data: {'action': 'getregion','account_id': id},
        success: getOther
    })
}
function getProject(id) {
    var getOther = function () {
        getRegion(id)
    }
    getInfo({
        // get project
        to: 'id_project',
        data: {'action': 'getproject','account_id': id},
        success: getOther
    })
}

$(document).ready(function () {
    $('.select2').select2({
        allowClear: true
    });
    $(".labels").select2({
        allowClear: true,
        templateSelection: format
    });
    $('#id_nodes.select2').select2({
        closeOnSelect: false
    });
    $("#id_account").change(function() {
        var id = $("#id_account").val();
        getProject(id)
    });

    $("#id_project").change(function() {
        var id = $("#id_account").val();
        getRegion(id)
    });

    $("#id_region").change(function() {
        var id = $("#id_account").val();
        var region = $(this).val();
        getZone(id, region)
    });

    $("#id_image_type").change(function() {
        var id = $("#id_account").val();
        var projectid = $("#id_project").val();
        var regionid = $("#id_region").val();
        var zoneid = $("#id_zone").val();
        var ostype = $("#id_os_type").val();
        var imagetype = $("#id_image_type").val();
        getInfo({
            //get region
            to: 'id_image',
            data: { "action":"getimage","account_id":id,"project_id":projectid,
                    "region":regionid,"zone":zoneid, "os_type":ostype, "image_type":imagetype
                    },
        });
    });

    $("#id_vpc").change(function() {
        var id = $("#id_account").val();
        var projectID = $("#id_project").val();
        var region = $("#id_region").val();
        getSubnet(id, region, projectID)
    });

    $("#id_eip").click(function () {
        console.log($(this).is(':checked'))
        if ($(this).is(':checked')){
            $('.vpc').css("display", "block");
        } else {
            $('.vpc').css("display","none");
        }
    });
});
</script>
{% endblock %}